blueprint:
  name: Hydro-Qu√©bec Cr√©dits Hivernaux (√âv√©nements de calendrier)
  description: '# Gestion des √©v√©nements de cr√©dit hivernal via calendrier.


    Ce blueprint utilise les √©v√©nements de calendrier cr√©√©s automatiquement par l''int√©gration
    Hydro-Qu√©bec pour d√©clencher vos automatisations lors des p√©riodes de pointe critique
    et non-critique (si configur√©).


    **Pr√©requis** : Vous devez avoir configur√© un calendrier dans les options de
    votre int√©gration Hydro-Qu√©bec D+CPC (Cr√©dits Hivernaux).


    ## Configuration


    ### S√©lection du calendrier

    S√©lectionnez le calendrier que vous avez configur√© dans l''int√©gration Hydro-Qu√©bec
    pour recevoir les √©v√©nements de pointe.


    ### P√©riode de pr√©-chauffage

    D√©finissez combien de temps avant le d√©but de l''√©v√©nement vous souhaitez commencer
    le pr√©-chauffage de votre r√©sidence (en minutes).


    ### P√©riodes d''ancrage

    Les p√©riodes d''ancrage sont des p√©riodes de notification avant les pointes :

    - Pointes du matin (AM, 6h-10h) : Ancrage d√©bute 5h avant, se termine 2h avant la pointe

    - Pointes du soir (PM, 16h-20h) : Ancrage d√©bute 4h avant, se termine 2h avant la pointe


    Ce blueprint utilise des d√©clencheurs multiples pour capturer toutes les combinaisons possibles.
    Les valeurs par d√©faut couvrent les deux cas (matin et soir), d√©clenchant aux moments appropri√©s
    selon l''√©v√©nement de calendrier.


    ### Actions


    D√©finition des actions √† effectuer dans Home-Assistant lors de chaque d√©but et
    fin de p√©riodes.


    **Note** : Ce blueprint d√©clenche les actions pour tous les √©v√©nements du calendrier.
    Si vous avez activ√© les pointes non-critiques dans votre configuration, les actions
    seront d√©clench√©es pour ces √©v√©nements √©galement. Utilisez des conditions dans
    vos actions si vous souhaitez diff√©rencier les comportements.


    ### M√©tadonn√©es disponibles


    Les √©v√©nements de calendrier incluent des m√©tadonn√©es accessibles dans vos actions :

    - trigger.calendar_event.summary : Titre (üî¥ Pointe critique / ‚ö™ Pointe r√©guli√®re)

    - trigger.calendar_event.location : Tarif (Hydro-Qu√©bec DCPC)

    - trigger.calendar_event.description : Contient Critique: Oui/Non, Tarif: DCPC, etc.


    **Exemple de condition** pour diff√©rencier pointes critiques et non-critiques :

    condition: template / value_template: "{{ ''Critique: Oui'' in trigger.calendar_event.description }}"


    Vous trouverez plus de d√©tails sur les logiques applicables pour les cr√©dits hivernaux

    dans la [documentation Hydro-Qu√©bec](https://www.hydroquebec.com/residentiel/espace-clients/tarifs/option-credit-hivernal.html).

    '
  domain: automation
  input:
    hydroqc_calendar:
      name: Calendrier Hydro-Qu√©bec
      description: S√©lectionnez le calendrier configur√© dans l'int√©gration Hydro-Qu√©bec pour les √©v√©nements de pointe
      selector:
        entity:
          domain: calendar
          multiple: false
    preheat_offset:
      name: D√©lai de pr√©-chauffage (minutes)
      description: Temps avant le d√©but de l'√©v√©nement pour commencer le pr√©-chauffage (ex. 120 minutes)
      default: 120
      selector:
        number:
          min: 0
          max: 240
          step: 15
          unit_of_measurement: minutes
          mode: slider
    anchor_start_morning_action:
      name: (Optionnel) Action d√©but ancrage matin
      description: 'Actions √† effectuer 5 heures avant une pointe du matin (AM). Se d√©clenche vers 1h pour une pointe √† 6h.'
      default: []
      selector:
        action: {}
    anchor_start_evening_action:
      name: (Optionnel) Action d√©but ancrage soir
      description: 'Actions √† effectuer 4 heures avant une pointe du soir (PM). Se d√©clenche vers 12h pour une pointe √† 16h.'
      default: []
      selector:
        action: {}
    anchor_end_action:
      name: (Optionnel) Action fin ancrage
      description: 'Actions √† effectuer 2 heures avant le d√©but de toute pointe (AM ou PM). C''est la fin de la p√©riode d''ancrage.'
      default: []
      selector:
        action: {}
    pre_heat_start_action:
      name: Action de pr√©-chauffage
      description: Actions √† effectuer avant la p√©riode de pointe pour pr√©-chauffer votre r√©sidence.
      default: []
      selector:
        action: {}
    peak_start_action:
      name: Action d√©but pointe
      description: Actions √† effectuer au d√©but de la p√©riode de pointe pour r√©duire votre consommation √©lectrique.
      default: []
      selector:
        action: {}
    peak_end_action:
      name: Action fin pointe
      description: Actions √† effectuer √† la fin de la p√©riode de pointe pour r√©tablir votre consommation normale.
      default: []
      selector:
        action: {}
  source_url: https://github.com/hydroqc/hydroqc-ha/blob/main/blueprints/winter-credits-calendar.yaml
mode: parallel
trigger:
  # Morning anchor start: 5 hours before (for AM peaks, e.g., 1h for 6h peak)
  - platform: calendar
    entity_id: !input hydroqc_calendar
    event: start
    offset: "-5:00:00"
    id: anchor_start_morning_trigger
  # Evening anchor start: 4 hours before (for PM peaks, e.g., 12h for 16h peak)
  - platform: calendar
    entity_id: !input hydroqc_calendar
    event: start
    offset: "-4:00:00"
    id: anchor_start_evening_trigger
  # Anchor end: 2 hours before (applies to both AM and PM peaks)
  - platform: calendar
    entity_id: !input hydroqc_calendar
    event: start
    offset: "-2:00:00"
    id: anchor_end_trigger
  # Pre-heat start: configurable offset before peak
  - platform: calendar
    entity_id: !input hydroqc_calendar
    event: start
    offset: !input preheat_offset
    id: pre_heat_trigger
  # Peak start
  - platform: calendar
    entity_id: !input hydroqc_calendar
    event: start
    id: peak_start_trigger
  # Peak end
  - platform: calendar
    entity_id: !input hydroqc_calendar
    event: end
    id: peak_end_trigger
# Add condition to filter only peak events (title contains "pointe")
condition:
  - condition: template
    value_template: "{{ 'pointe' in trigger.calendar_event.summary | lower }}"
action:
  - choose:
      - conditions:
          - condition: trigger
            id: anchor_start_morning_trigger
          # Optional: Add rate filter (trigger.calendar_event.location contains 'DCPC')
          # Optional: Check if critical (trigger.calendar_event.description contains 'Critique: Oui')
        sequence: !input anchor_start_morning_action
      - conditions:
          - condition: trigger
            id: anchor_start_evening_trigger
        sequence: !input anchor_start_evening_action
      - conditions:
          - condition: trigger
            id: anchor_end_trigger
        sequence: !input anchor_end_action
      - conditions:
          - condition: trigger
            id: pre_heat_trigger
        sequence: !input pre_heat_start_action
      - conditions:
          - condition: trigger
            id: peak_start_trigger
        sequence: !input peak_start_action
      - conditions:
          - condition: trigger
            id: peak_end_trigger
        sequence: !input peak_end_action
