blueprint:
  name: Hydro-Qu√©bec Cr√©dits Hivernaux (√âv√©nements de calendrier)
  description: |
    # Gestion des √©v√©nements de cr√©dit hivernal via calendrier.

    Ce blueprint utilise les √©v√©nements de calendrier cr√©√©s automatiquement par l'int√©gration Hydro-Qu√©bec pour d√©clencher vos automatisations lors des p√©riodes de pointe critique et non-critique (si configur√©).

    **Pr√©requis** : Vous devez avoir configur√© un calendrier dans les options de votre int√©gration Hydro-Qu√©bec D+CPC (Cr√©dits Hivernaux).

    ## Configuration

    ### S√©lection du calendrier

    S√©lectionnez le calendrier que vous avez configur√© dans l'int√©gration Hydro-Qu√©bec pour recevoir les √©v√©nements de pointe.

    ### P√©riode de pr√©-chauffage

    D√©finissez combien de temps avant le d√©but de l'√©v√©nement vous souhaitez commencer le pr√©-chauffage de votre r√©sidence (en minutes).

    ### P√©riodes d'ancrage
    Les p√©riodes d'ancrage sont des p√©riodes de notification avant les pointes :
    - Pointes du matin (AM, 6h-10h) : Ancrage d√©bute 5h avant, se termine 2h avant la pointe
    - Pointes du soir (PM, 16h-20h) : Ancrage d√©bute 4h avant, se termine 2h avant la pointe

    Ce blueprint utilise des d√©clencheurs multiples pour capturer toutes les combinaisons possibles. Les valeurs par d√©faut couvrent les deux cas (matin et soir), d√©clenchant aux moments appropri√©s selon l'√©v√©nement de calendrier.

    ### Actions

    D√©finition des actions √† effectuer dans Home-Assistant lors de chaque d√©but et fin de p√©riodes.

    **Important** : Pour √©viter qu'une erreur dans une action emp√™che l'ex√©cution des actions suivantes, il est recommand√© d'utiliser des appels d'actions en parall√®le. Exemple : au lieu d'une s√©quence simple, utilisez `parallel:` pour grouper vos actions.

    **Workflows complexes** : Si vous avez besoin de logiques conditionnelles complexes ou de nombreuses √©tapes, il est recommand√© d'utiliser ce blueprint pour d√©clencher des automatisations s√©par√©es plut√¥t que d'inclure toute la logique ici. Cela facilite la maintenance et le d√©bogage.

    **Note** : Ce blueprint diff√©rencie automatiquement les pointes critiques et non-critiques selon les m√©tadonn√©es de l'√©v√©nement. Vous pouvez d√©finir des actions diff√©rentes pour chaque type de pointe.


    ### M√©tadonn√©es disponibles

    Les √©v√©nements de calendrier incluent des m√©tadonn√©es accessibles dans vos actions :

    - trigger.calendar_event.summary : Titre (üî¥ Pointe critique / ‚ö™ Pointe r√©guli√®re)
  
    - trigger.calendar_event.description : Contient Critique: Oui/Non, Tarif: DCPC, etc.

    **Le blueprint d√©tecte automatiquement** si une pointe est critique en v√©rifiant
    la pr√©sence de "Critique: Oui" dans la description de l''√©v√©nement.

    ### Cr√©ation manuelle d'√©v√©nements

    Si l'int√©gration ne cr√©e pas automatiquement les √©v√©nements (API indisponible, probl√®me de configuration), vous pouvez cr√©er manuellement des √©v√©nements dans votre calendrier :

    1. Cr√©ez un √©v√©nement aux heures de pointe (6h-10h ou 16h-20h)
    2. Titre: "üî¥ Pointe critique" ou "‚ö™ Pointe r√©guli√®re"
    3. Description:
    ```
    Tarif: DCPC
    Critique: Oui (ou Non)
    ```
 
    Vous trouverez plus de d√©tails sur les logiques applicables pour les cr√©dits hivernaux dans la [documentation Hydro-Qu√©bec](https://hydroqc.ca/fr/docs/tarification-dynamique/).
  domain: automation
  input:
    hydroqc_calendar:
      name: Calendrier Hydro-Qu√©bec
      description: S√©lectionnez le calendrier configur√© dans l'int√©gration Hydro-Qu√©bec pour les √©v√©nements de pointe
      selector:
        entity:
          domain: calendar
          multiple: false
    preheat_offset:
      name: D√©lai de pr√©-chauffage
      description: "Temps avant le d√©but de l'√©v√©nement pour commencer le pr√©-chauffage (format -HH:MM:SS, ex: -02:00:00 pour 2 heures avant, -01:30:00 pour 1h30 avant)"
      default: "-02:00:00"
      selector:
        text:
          type: text
    critical_peak_offset:
      name: D√©lai avant d√©but pointe critique
      description: "Temps avant le d√©but officiel de la pointe pour d√©clencher les actions (permet aux appareils de se stabiliser avant la pointe). Format -HH:MM:SS, ex: -00:01:00 pour 1 minute avant"
      default: "-00:01:00"
      selector:
        text:
          type: text
    
    # ===== ACTIONS ESSENTIELLES =====
    # Actions pour les pointes CRITIQUES (prioritaires)
    critical_pre_heat_start_action:
      name: "[Critique] Action pr√©-chauffage"
      description: 'Actions pour pointes CRITIQUES - avant pointe (d√©faut 2h). Ex: Maximisez chauffage pour atteindre temp√©rature √©lev√©e.'
      default:
        - parallel:
            - alias: Action 1
              # Votre action ici
            - alias: Action 2
              # Votre action ici
      selector:
        action: {}
    critical_peak_start_action:
      name: "[Critique] Action d√©but pointe"
      description: 'Actions pour pointes CRITIQUES - d√©but pointe (6h/16h). Ex: R√©duction agressive - fermez chauffe-eau, minimisez CVAC.'
      default:
        - parallel:
            - alias: Action 1
              # Votre action ici
            - alias: Action 2
              # Votre action ici
      selector:
        action: {}
    critical_peak_end_action:
      name: "[Critique] Action fin pointe"
      description: |
        Actions pour pointes CRITIQUES - fin pointe (10h/20h). Ex: R√©tablissez tous appareils √† op√©ration normale.
        
        **D√©lai al√©atoire par d√©faut (30 sec - 5 min)** : √âvite une surcharge du r√©seau √©lectrique caus√©e par le red√©marrage simultan√© de milliers d'appareils √† la fin de la pointe. Si vous avez plusieurs actions de reprise, ajoutez un d√©lai al√©atoire similaire entre chacune pour √©taler la consommation.
      default:
        - delay:
            seconds: "{{ range(30, 300)|random|int }}"
          alias: D√©lai al√©atoire 30 sec - 5 minutes
      selector:
        action: {}
    
    # ===== ACTIONS OPTIONNELLES =====
    # Actions pour les pointes R√âGULI√àRES (non-critiques)
    regular_peak_actions:
      name: "‚ö™ Actions pointes r√©guli√®res (optionnel)"
      description: "Actions pour les pointes non-critiques. Ces pointes font partie de l'horaire r√©gulier (tous les jours en hiver) et ne sont g√©n√©ralement pas annonc√©es par Hydro-Qu√©bec."
      collapsed: true
      input:
        regular_peak_start_action:
          name: "[R√©guli√®re] D√©but pointe"
          description: 'Pointes R√âGULI√àRES - d√©but pointe (6h/16h). Ex: R√©duction l√©g√®re - baisse temp, reportez charges non-essentielles.'
          default: []
          selector:
            action: {}
        regular_peak_end_action:
          name: "[R√©guli√®re] Fin pointe"
          description: 'Pointes R√âGULI√àRES - fin pointe (10h/20h). Ex: R√©tablissez r√©glages normaux.'
          default: []
          selector:
            action: {}
    
    # ===== ACTIONS OPTIONNELLES (ANCRAGE) =====
    # P√©riode d'ancrage - permet d'√©tablir une consommation de r√©f√©rence
    anchor_actions:
      name: "‚öôÔ∏è Actions d'ancrage (optionnel)"
      description: "Les actions d'ancrage permettent d'√©tablir une consommation de r√©f√©rence avant les pointes. Ces actions sont optionnelles."
      collapsed: true
      input:
        critical_anchor_start_morning_action:
          name: "[Critique] D√©but ancrage matin"
          description: 'Pointes CRITIQUES - 5h avant pointe matin (1h). Maintenez consommation normale.'
          default: []
          selector:
            action: {}
        critical_anchor_start_evening_action:
          name: "[Critique] D√©but ancrage soir"
          description: 'Pointes CRITIQUES - 4h avant pointe soir (12h). Maintenez consommation normale.'
          default: []
          selector:
            action: {}
        critical_anchor_end_morning_action:
          name: "[Critique] Fin ancrage matin"
          description: 'Pointes CRITIQUES - 2h avant pointe matin (4h). Fin ancrage.'
          default: []
          selector:
            action: {}
        critical_anchor_end_evening_action:
          name: "[Critique] Fin ancrage soir"
          description: 'Pointes CRITIQUES - 2h avant pointe soir (14h). Fin ancrage.'
          default: []
          selector:
            action: {}
        regular_anchor_start_morning_action:
          name: "[R√©guli√®re] D√©but ancrage matin"
          description: 'Pointes R√âGULI√àRES - 5h avant pointe matin (1h). Maintenez normal.'
          default: []
          selector:
            action: {}
        regular_anchor_start_evening_action:
          name: "[R√©guli√®re] D√©but ancrage soir"
          description: 'Pointes R√âGULI√àRES - 4h avant pointe soir (12h). Maintenez normal.'
          default: []
          selector:
            action: {}
        regular_anchor_end_morning_action:
          name: "[R√©guli√®re] Fin ancrage matin"
          description: 'Pointes R√âGULI√àRES - 2h avant pointe matin (4h). Fin ancrage.'
          default: []
          selector:
            action: {}
        regular_anchor_end_evening_action:
          name: "[R√©guli√®re] Fin ancrage soir"
          description: 'Pointes R√âGULI√àRES - 2h avant pointe soir (14h). Fin ancrage.'
          default: []
          selector:
            action: {}
  source_url: https://github.com/hydroqc/hydroqc-ha/blob/main/blueprints/winter-credits-calendar.yaml
mode: parallel
trigger:
  # Morning anchor start: 5 hours before (for AM peaks, e.g., 1h for 6h peak)
  - platform: calendar
    entity_id: !input hydroqc_calendar
    event: start
    offset: "-5:00:00"
    id: anchor_start_morning_trigger
  # Evening anchor start: 4 hours before (for PM peaks, e.g., 12h for 16h peak)
  - platform: calendar
    entity_id: !input hydroqc_calendar
    event: start
    offset: "-4:00:00"
    id: anchor_start_evening_trigger
  # Morning anchor end: 2 hours before AM peak (e.g., 4h for 6h peak)
  - platform: calendar
    entity_id: !input hydroqc_calendar
    event: start
    offset: "-2:00:00"
    id: anchor_end_morning_trigger
  # Evening anchor end: 2 hours before PM peak (e.g., 14h for 16h peak)
  - platform: calendar
    entity_id: !input hydroqc_calendar
    event: start
    offset: "-2:00:00"
    id: anchor_end_evening_trigger
  # Pre-heat start: configurable offset before peak
  - platform: calendar
    entity_id: !input hydroqc_calendar
    event: start
    offset: !input preheat_offset
    id: pre_heat_trigger
  # Critical peak start: configurable offset before official peak start (default 1min before)
  - platform: calendar
    entity_id: !input hydroqc_calendar
    event: start
    offset: !input critical_peak_offset
    id: critical_peak_start_trigger
  # Regular peak start (no offset)
  - platform: calendar
    entity_id: !input hydroqc_calendar
    event: start
    id: regular_peak_start_trigger
  # Peak end
  - platform: calendar
    entity_id: !input hydroqc_calendar
    event: end
    id: peak_end_trigger
# Add condition to filter only peak events (title contains "pointe")
condition:
  - condition: template
    value_template: "{{ 'pointe' in trigger.calendar_event.summary | lower }}"
action:
  - choose:
      # Morning anchor start - CRITICAL
      - conditions:
          - condition: trigger
            id: anchor_start_morning_trigger
          - condition: template
            value_template: "{{ 'Critique: Oui' in trigger.calendar_event.description }}"
        sequence: !input critical_anchor_start_morning_action
      # Morning anchor start - REGULAR
      - conditions:
          - condition: trigger
            id: anchor_start_morning_trigger
          - condition: template
            value_template: "{{ 'Critique: Non' in trigger.calendar_event.description }}"
        sequence: !input regular_anchor_start_morning_action
      
      # Evening anchor start - CRITICAL
      - conditions:
          - condition: trigger
            id: anchor_start_evening_trigger
          - condition: template
            value_template: "{{ 'Critique: Oui' in trigger.calendar_event.description }}"
        sequence: !input critical_anchor_start_evening_action
      # Evening anchor start - REGULAR
      - conditions:
          - condition: trigger
            id: anchor_start_evening_trigger
          - condition: template
            value_template: "{{ 'Critique: Non' in trigger.calendar_event.description }}"
        sequence: !input regular_anchor_start_evening_action
      
      # Morning anchor end - CRITICAL
      - conditions:
          - condition: trigger
            id: anchor_end_morning_trigger
          - condition: template
            value_template: "{{ 'Critique: Oui' in trigger.calendar_event.description }}"
        sequence: !input critical_anchor_end_morning_action
      # Morning anchor end - REGULAR
      - conditions:
          - condition: trigger
            id: anchor_end_morning_trigger
          - condition: template
            value_template: "{{ 'Critique: Non' in trigger.calendar_event.description }}"
        sequence: !input regular_anchor_end_morning_action
      
      # Evening anchor end - CRITICAL
      - conditions:
          - condition: trigger
            id: anchor_end_evening_trigger
          - condition: template
            value_template: "{{ 'Critique: Oui' in trigger.calendar_event.description }}"
        sequence: !input critical_anchor_end_evening_action
      # Evening anchor end - REGULAR
      - conditions:
          - condition: trigger
            id: anchor_end_evening_trigger
          - condition: template
            value_template: "{{ 'Critique: Non' in trigger.calendar_event.description }}"
        sequence: !input regular_anchor_end_evening_action
      
      # Pre-heat - CRITICAL ONLY (regular peaks don't have preheat)
      - conditions:
          - condition: trigger
            id: pre_heat_trigger
          - condition: template
            value_template: "{{ 'Critique: Oui' in trigger.calendar_event.description }}"
        sequence: !input critical_pre_heat_start_action
      
      # Peak start - CRITICAL (with offset before official start)
      - conditions:
          - condition: trigger
            id: critical_peak_start_trigger
          - condition: template
            value_template: "{{ 'Critique: Oui' in trigger.calendar_event.description }}"
        sequence: !input critical_peak_start_action
      # Peak start - REGULAR (at official start time)
      - conditions:
          - condition: trigger
            id: regular_peak_start_trigger
          - condition: template
            value_template: "{{ 'Critique: Non' in trigger.calendar_event.description }}"
        sequence: !input regular_peak_start_action
      
      # Peak end - CRITICAL
      - conditions:
          - condition: trigger
            id: peak_end_trigger
          - condition: template
            value_template: "{{ 'Critique: Oui' in trigger.calendar_event.description }}"
        sequence: !input critical_peak_end_action
      # Peak end - REGULAR
      - conditions:
          - condition: trigger
            id: peak_end_trigger
          - condition: template
            value_template: "{{ 'Critique: Non' in trigger.calendar_event.description }}"
        sequence: !input regular_peak_end_action
    default:
      - parallel: []
