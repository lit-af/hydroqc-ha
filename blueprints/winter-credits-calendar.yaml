blueprint:
  name: Hydro-Qu√©bec Cr√©dits Hivernaux (√âv√©nements de calendrier)
  description: |
    # Gestion automatis√©e des Cr√©dits Hivernaux (D+CPC).

    Ce blueprint d√©clenche des automatisations √† heures fixes pour les p√©riodes de pointe et d'ancrage, puis v√©rifie le calendrier Hydro-Qu√©bec pour d√©terminer si c'est une pointe critique ou r√©guli√®re et ex√©cute les actions appropri√©es.

    **Fonctionnement** : 
    - D√©clencheurs √† heures fixes pour ancrage et pointes (01h, 04h, 06h, 10h, 12h, 14h, 16h, 20h)
    - D√©clencheurs calendrier avec offset pour pr√©-chauffage (par d√©faut -01:45:00 avant pointes critiques)
    - V√©rifie automatiquement si un √©v√©nement critique existe dans le calendrier
    - Ex√©cute les actions critiques (si √©v√©nement calendrier) ou r√©guli√®res (horaire quotidien)
    - Le pr√©-chauffage se d√©clenche automatiquement via les √©v√©nements calendrier (pointes critiques uniquement)

    **Pr√©requis** : Vous devez avoir configur√© un calendrier dans les options de votre int√©gration Hydro-Qu√©bec D+CPC (Cr√©dits Hivernaux).

    ## Configuration

    ### S√©lection du calendrier

    S√©lectionnez le calendrier configur√© dans l'int√©gration Hydro-Qu√©bec. Le calendrier contient uniquement les pointes **critiques** annonc√©es par Hydro-Qu√©bec.

    ### Pr√©-chauffage (pointes critiques seulement)

    Configurez le d√©lai avant les pointes critiques pour commencer le pr√©-chauffage. Utilise les √©v√©nements du calendrier avec un offset.
    - Par d√©faut : -01:45:00 (1h45 avant le d√©but de la pointe critique)
    - Le pr√©-chauffage se d√©clenche automatiquement UNIQUEMENT pour les √©v√©nements critiques dans le calendrier

    ### Horaire quotidien (pointes r√©guli√®res)

    Les pointes r√©guli√®res suivent un horaire fixe pendant la saison hivernale (1er d√©cembre au 31 mars) :
    - **Ancrage matin** : 01h-04h (√©tablit consommation de r√©f√©rence)
    - **Pointe matin** : 06h-10h
    - **Ancrage soir** : 12h-14h (√©tablit consommation de r√©f√©rence)
    - **Pointe soir** : 16h-20h

    ### Pointes critiques

    Hydro-Qu√©bec annonce les pointes critiques vers midi la veille. Ces √©v√©nements apparaissent dans votre calendrier et remplacent les actions r√©guli√®res pour cette journ√©e.

    ### Actions

    D√©finissez vos actions pour chaque p√©riode. Le blueprint choisit automatiquement entre actions critiques et r√©guli√®res selon la pr√©sence d'un √©v√©nement calendrier.

    **Important** : Pour √©viter qu'une erreur bloque l'ex√©cution, utilisez des actions en parall√®le (`parallel:`).

    **Pr√©-chauffage** : Pour pr√©-chauffer avant les pointes critiques, ajoutez la logique dans l'action "d√©but pointe critique" ou cr√©ez une automatisation s√©par√©e.

    ### Cr√©ation manuelle d'√©v√©nements

    Si l'int√©gration ne cr√©e pas automatiquement les √©v√©nements, vous pouvez les cr√©er manuellement :

    1. Cr√©ez un √©v√©nement le jour de la pointe critique (6h-10h ou 16h-20h)
    2. Titre: contient "pointe" (ex: "üî¥ Pointe critique")
    3. Description (optionnel): `Tarif: DCPC` et `Critique: Oui`
 
    Plus de d√©tails sur les [cr√©dits hivernaux](https://hydroqc.ca/fr/docs/tarification-dynamique/).
  domain: automation
  input:
    hydroqc_calendar:
      name: Calendrier Hydro-Qu√©bec
      description: S√©lectionnez le calendrier configur√© dans l'int√©gration Hydro-Qu√©bec pour les √©v√©nements de pointe
      selector:
        entity:
          domain: calendar
          multiple: false
    
    preheat_offset_morning:
      name: D√©lai de pr√©-chauffage (matin)
      description: "Temps avant le d√©but de la pointe du matin pour commencer le pr√©-chauffage (format -HH:MM:SS, ex: -02:00:00 pour 2 heures avant, -01:45:00 pour 1h45 avant)"
      default: "-01:45:00"
      selector:
        text:
          type: text
    
    preheat_offset_evening:
      name: D√©lai de pr√©-chauffage (soir)
      description: "Temps avant le d√©but de la pointe du soir pour commencer le pr√©-chauffage (format -HH:MM:SS, ex: -02:00:00 pour 2 heures avant, -01:45:00 pour 1h45 avant)"
      default: "-01:45:00"
      selector:
        text:
          type: text
    
    # ===== ACTIONS ESSENTIELLES =====
    # Actions pour les pointes CRITIQUES (prioritaires)
    critical_preheat_morning_action:
      name: "[Critique] Action pr√©-chauffage (matin)"
      description: 'Actions pour pointes CRITIQUES - pr√©-chauffage avant pointe matin. Ex: Maximisez chauffage pour atteindre temp√©rature √©lev√©e. Ne se d√©clenche QUE si un √©v√©nement critique existe dans le calendrier pour aujourd''hui.'
      default:
        - parallel:
            - action: persistent_notification.create
              data:
                title: "üî• Pr√©-chauffage Cr√©dits hivernaux (matin)"
                message: "D√©but du pr√©-chauffage avant pointe critique du matin. Augmentez le chauffage maintenant."
      selector:
        action: {}
    
    critical_preheat_evening_action:
      name: "[Critique] Action pr√©-chauffage (soir)"
      description: 'Actions pour pointes CRITIQUES - pr√©-chauffage avant pointe soir. Ex: Maximisez chauffage pour atteindre temp√©rature √©lev√©e. Ne se d√©clenche QUE si un √©v√©nement critique existe dans le calendrier pour aujourd''hui.'
      default:
        - parallel:
            - action: persistent_notification.create
              data:
                title: "üî• Pr√©-chauffage Cr√©dits hivernaux (soir)"
                message: "D√©but du pr√©-chauffage avant pointe critique du soir. Augmentez le chauffage maintenant."
      selector:
        action: {}
    
    critical_peak_start_action:
      name: "[Critique] Action d√©but pointe"
      description: 'Actions pour pointes CRITIQUES - d√©but pointe (6h/16h). Ex: R√©duction agressive - fermez chauffe-eau, minimisez CVAC. Le pr√©-chauffage est g√©r√© s√©par√©ment via les actions de pr√©-chauffage configurables.'
      default:
        - parallel:
            - action: persistent_notification.create
              data:
                title: "üî¥ Pointe critique Cr√©dits hivernaux"
                message: "D√©but de la pointe critique. R√©duisez votre consommation maintenant."
      selector:
        action: {}
    critical_peak_end_action:
      name: "[Critique] Action fin pointe"
      description: |
        Actions pour pointes CRITIQUES - fin pointe (10h/20h). Ex: R√©tablissez tous appareils √† op√©ration normale.
        
        **D√©lai al√©atoire par d√©faut (30 sec - 5 min)** : √âvite une surcharge du r√©seau √©lectrique caus√©e par le red√©marrage simultan√© de milliers d'appareils √† la fin de la pointe. Si vous avez plusieurs actions de reprise, ajoutez un d√©lai al√©atoire similaire entre chacune pour √©taler la consommation.
      default:
        - delay:
            seconds: "{{ range(30, 300)|random|int }}"
          alias: D√©lai al√©atoire 30 sec - 5 minutes
        - parallel:
            - action: persistent_notification.create
              data:
                title: "‚úÖ Fin pointe critique Cr√©dits hivernaux"
                message: "Fin de la pointe critique. Vous pouvez r√©tablir votre consommation normale."
      selector:
        action: {}
    
    # ===== ACTIONS OPTIONNELLES =====
    # Actions pour les pointes R√âGULI√àRES (non-critiques)
    regular_peak_actions:
      name: "‚ö™ Actions pointes r√©guli√®res"
      description: "Actions ex√©cut√©es lors des pointes quotidiennes R√âGULI√àRES (6h-10h et 16h-20h) quand AUCUN √©v√©nement critique n'est pr√©sent dans le calendrier. Ces actions s'ex√©cutent automatiquement selon l'horaire fixe hivernal."
      collapsed: true
      input:
        regular_peak_start_action:
          name: "[R√©guli√®re] D√©but pointe"
          description: 'Pointes R√âGULI√àRES - d√©but pointe (6h/16h). Notification d√©sactiv√©e par d√©faut - retirez le mode `enabled: false` pour activer.'
          default:
            - enabled: false
              parallel:
                - action: persistent_notification.create
                  data:
                    title: "‚ö™ Pointe r√©guli√®re Cr√©dits hivernaux"
                    message: "D√©but de la pointe r√©guli√®re. R√©duction optionnelle de consommation."
          selector:
            action: {}
        regular_peak_end_action:
          name: "[R√©guli√®re] Fin pointe"
          description: 'Pointes R√âGULI√àRES - fin pointe (10h/20h). Notification d√©sactiv√©e par d√©faut - retirez le mode `enabled: false` pour activer.'
          default:
            - enabled: false
              parallel:
                - action: persistent_notification.create
                  data:
                    title: "‚úÖ Fin pointe r√©guli√®re Cr√©dits hivernaux"
                    message: "Fin de la pointe r√©guli√®re."
          selector:
            action: {}
    
    # ===== ACTIONS OPTIONNELLES (ANCRAGE) =====
    # P√©riode d'ancrage - permet d'√©tablir une consommation de r√©f√©rence
    anchor_actions:
      name: "‚öôÔ∏è Actions d'ancrage (optionnel)"
      description: "Les actions d'ancrage permettent d'√©tablir une consommation de r√©f√©rence avant les pointes. Ces actions sont optionnelles."
      collapsed: true
      input:
        critical_anchor_start_morning_action:
          name: "[Critique] D√©but ancrage matin"
          description: 'Pointes CRITIQUES - 5h avant pointe matin (1h). Notification d√©sactiv√©e par d√©faut - retirez le mode `enabled: false` pour activer.'
          default:
            - enabled: false
              parallel:
                - action: persistent_notification.create
                  data:
                    title: "üî¥ Ancrage critique matin Cr√©dits hivernaux"
                    message: "D√©but de l'ancrage critique du matin. Maintenez votre consommation normale pour √©tablir une r√©f√©rence."
          selector:
            action: {}
        critical_anchor_start_evening_action:
          name: "[Critique] D√©but ancrage soir"
          description: 'Pointes CRITIQUES - 4h avant pointe soir (12h). Notification d√©sactiv√©e par d√©faut - retirez le mode `enabled: false` pour activer.'
          default:
            - enabled: false
              parallel:
                - action: persistent_notification.create
                  data:
                    title: "üî¥ Ancrage critique soir Cr√©dits hivernaux"
                    message: "D√©but de l'ancrage critique du soir. Maintenez votre consommation normale pour √©tablir une r√©f√©rence."
          selector:
            action: {}
        critical_anchor_end_morning_action:
          name: "[Critique] Fin ancrage matin"
          description: |
            Pointes CRITIQUES - 2h avant pointe matin (4h). Fin ancrage.
            
            **‚ö†Ô∏è Attention** : Si votre d√©lai de pr√©-chauffage est <= -02:00:00, il y aura chevauchement avec cette action. La fin d'ancrage se d√©clenche √† 4h pour une pointe √† 6h.
            
            Notification d√©sactiv√©e par d√©faut - retirez le mode `enabled: false` pour activer.
          default:
            - enabled: false
              parallel:
                - action: persistent_notification.create
                  data:
                    title: "‚úÖ Fin ancrage critique matin Cr√©dits hivernaux"
                    message: "Fin de l'ancrage critique du matin. Pr√©parez-vous pour le pr√©-chauffage."
          selector:
            action: {}
        critical_anchor_end_evening_action:
          name: "[Critique] Fin ancrage soir"
          description: |
            Pointes CRITIQUES - 2h avant pointe soir (14h). Fin ancrage.
            
            **‚ö†Ô∏è Attention** : Si votre d√©lai de pr√©-chauffage est <= -02:00:00, il y aura chevauchement avec cette action. La fin d'ancrage se d√©clenche √† 14h pour une pointe √† 16h.
            
            Notification d√©sactiv√©e par d√©faut - retirez le mode `enabled: false` pour activer.
          default:
            - enabled: false
              parallel:
                - action: persistent_notification.create
                  data:
                    title: "‚úÖ Fin ancrage critique soir Cr√©dits hivernaux"
                    message: "Fin de l'ancrage critique du soir. Pr√©parez-vous pour le pr√©-chauffage."
          selector:
            action: {}
        regular_anchor_start_morning_action:
          name: "[R√©guli√®re] D√©but ancrage matin"
          description: 'Pointes R√âGULI√àRES - 5h avant pointe matin (1h). Notification d√©sactiv√©e par d√©faut - retirez le mode `enabled: false` pour activer.'
          default:
            - enabled: false
              parallel:
                - action: persistent_notification.create
                  data:
                    title: "‚öôÔ∏è Ancrage matin Cr√©dits hivernaux"
                    message: "D√©but de l'ancrage du matin. Maintenez votre consommation normale."
          selector:
            action: {}
        regular_anchor_start_evening_action:
          name: "[R√©guli√®re] D√©but ancrage soir"
          description: 'Pointes R√âGULI√àRES - 4h avant pointe soir (12h). Notification d√©sactiv√©e par d√©faut - retirez le mode `enabled: false` pour activer.'
          default:
            - enabled: false
              parallel:
                - action: persistent_notification.create
                  data:
                    title: "‚öôÔ∏è Ancrage soir Cr√©dits hivernaux"
                    message: "D√©but de l'ancrage du soir. Maintenez votre consommation normale."
          selector:
            action: {}
        regular_anchor_end_morning_action:
          name: "[R√©guli√®re] Fin ancrage matin"
          description: 'Pointes R√âGULI√àRES - 2h avant pointe matin (4h). Notification d√©sactiv√©e par d√©faut - retirez le mode `enabled: false` pour activer.'
          default:
            - enabled: false
              parallel:
                - action: persistent_notification.create
                  data:
                    title: "‚úÖ Fin ancrage matin Cr√©dits hivernaux"
                    message: "Fin de l'ancrage du matin."
          selector:
            action: {}
        regular_anchor_end_evening_action:
          name: "[R√©guli√®re] Fin ancrage soir"
          description: 'Pointes R√âGULI√àRES - 2h avant pointe soir (14h). Notification d√©sactiv√©e par d√©faut - retirez le mode `enabled: false` pour activer.'
          default:
            - enabled: false
              parallel:
                - action: persistent_notification.create
                  data:
                    title: "‚úÖ Fin ancrage soir Cr√©dits hivernaux"
                    message: "Fin de l'ancrage du soir."
          selector:
            action: {}
  source_url: https://github.com/hydroqc/hydroqc-ha/blob/main/blueprints/winter-credits-calendar.yaml
mode: single
max_exceeded: silent
trigger:
  # === CALENDAR TRIGGERS (Critical peaks only - with offsets) ===
  # Morning preheat (configurable offset before morning peak)
  - platform: calendar
    entity_id: !input hydroqc_calendar
    event: start
    offset: !input preheat_offset_morning
    id: preheat_morning
  # Evening preheat (configurable offset before evening peak)
  - platform: calendar
    entity_id: !input hydroqc_calendar
    event: start
    offset: !input preheat_offset_evening
    id: preheat_evening
  
  # === TIME TRIGGERS (Fixed daily schedule) ===
  # Morning anchor start (1h)
  - platform: time
    at: "01:00:00"
    id: anchor_start_morning
  # Morning anchor end (4h)
  - platform: time
    at: "04:00:00"
    id: anchor_end_morning
  # Morning peak start (6h)
  - platform: time
    at: "06:00:00"
    id: peak_start_morning
  # Morning peak end (10h)
  - platform: time
    at: "10:00:00"
    id: peak_end_morning
  # Evening anchor start (12h)
  - platform: time
    at: "12:00:00"
    id: anchor_start_evening
  # Evening anchor end (14h)
  - platform: time
    at: "14:00:00"
    id: anchor_end_evening
  # Evening peak start (16h)
  - platform: time
    at: "16:00:00"
    id: peak_start_evening
  # Evening peak end (20h)
  - platform: time
    at: "20:00:00"
    id: peak_end_evening

# Season condition: only run during winter (Dec 1 - Mar 31)
# Calendar events: filter for DCPC peak events only (for multi-tariff calendars)
condition:
  - condition: template
    value_template: "{{ now().month == 12 or now().month <= 3 }}"
  - condition: or
    conditions:
      # Allow time-based triggers (non-calendar)
      - condition: template
        value_template: "{{ trigger.platform != 'calendar' }}"
      # For calendar triggers: validate DCPC tariff and peak event
      - condition: and
        conditions:
          - condition: template
            value_template: "{{ 'pointe' in trigger.calendar_event.summary | lower }}"
          - condition: template
            value_template: "{{ 'Tarif: DCPC' in trigger.calendar_event.description }}"
variables:
  calendar_entity: !input hydroqc_calendar

action:
  # Fetch today's calendar events to determine if peaks are critical or regular
  - action: calendar.get_events
    target:
      entity_id: !input hydroqc_calendar
    data:
      start_date_time: "{{ now().replace(hour=0, minute=0, second=0, microsecond=0).isoformat() }}"
      end_date_time: "{{ now().replace(hour=23, minute=59, second=59, microsecond=0).isoformat() }}"
    response_variable: calendar_events
  - variables:
      # Check if there's a critical morning peak (starting at 6h) today
      morning_peak_critical: >
        {{ calendar_events[calendar_entity].events 
           | selectattr('summary', 'search', '[Pp]ointe')
           | selectattr('description', 'search', 'Tarif: DCPC')
           | selectattr('start', 'search', now().strftime('%Y-%m-%dT06:'))
           | list | length > 0 }}
      # Check if there's a critical evening peak (starting at 16h) today
      evening_peak_critical: >
        {{ calendar_events[calendar_entity].events 
           | selectattr('summary', 'search', '[Pp]ointe')
           | selectattr('description', 'search', 'Tarif: DCPC')
           | selectattr('start', 'search', now().strftime('%Y-%m-%dT16:'))
           | list | length > 0 }}
  - choose:
      # ============================================
      # MORNING ANCHOR START (01:00)
      # ============================================
      - conditions:
          - condition: trigger
            id: anchor_start_morning
          - condition: template
            value_template: "{{ morning_peak_critical }}"
        sequence: !input critical_anchor_start_morning_action
      - conditions:
          - condition: trigger
            id: anchor_start_morning
          - condition: template
            value_template: "{{ not morning_peak_critical }}"
        sequence: !input regular_anchor_start_morning_action
      
      # ============================================
      # MORNING ANCHOR END (04:00)
      # ============================================
      - conditions:
          - condition: trigger
            id: anchor_end_morning
          - condition: template
            value_template: "{{ morning_peak_critical }}"
        sequence: !input critical_anchor_end_morning_action
      - conditions:
          - condition: trigger
            id: anchor_end_morning
          - condition: template
            value_template: "{{ not morning_peak_critical }}"
        sequence: !input regular_anchor_end_morning_action
      
      # ============================================
      # MORNING PREHEAT (calendar trigger with offset, critical only)
      # ============================================
      - conditions:
          - condition: trigger
            id: preheat_morning
        sequence: !input critical_preheat_morning_action
      
      # ============================================
      # MORNING PEAK START (06:00)
      # ============================================
      - conditions:
          - condition: trigger
            id: peak_start_morning
          - condition: template
            value_template: "{{ morning_peak_critical }}"
        sequence: !input critical_peak_start_action
      - conditions:
          - condition: trigger
            id: peak_start_morning
          - condition: template
            value_template: "{{ not morning_peak_critical }}"
        sequence: !input regular_peak_start_action
      
      # ============================================
      # MORNING PEAK END (10:00)
      # ============================================
      - conditions:
          - condition: trigger
            id: peak_end_morning
          - condition: template
            value_template: "{{ morning_peak_critical }}"
        sequence: !input critical_peak_end_action
      - conditions:
          - condition: trigger
            id: peak_end_morning
          - condition: template
            value_template: "{{ not morning_peak_critical }}"
        sequence: !input regular_peak_end_action
      
      # ============================================
      # EVENING ANCHOR START (12:00)
      # ============================================
      - conditions:
          - condition: trigger
            id: anchor_start_evening
          - condition: template
            value_template: "{{ evening_peak_critical }}"
        sequence: !input critical_anchor_start_evening_action
      - conditions:
          - condition: trigger
            id: anchor_start_evening
          - condition: template
            value_template: "{{ not evening_peak_critical }}"
        sequence: !input regular_anchor_start_evening_action
      
      # ============================================
      # EVENING ANCHOR END (14:00)
      # ============================================
      - conditions:
          - condition: trigger
            id: anchor_end_evening
          - condition: template
            value_template: "{{ evening_peak_critical }}"
        sequence: !input critical_anchor_end_evening_action
      - conditions:
          - condition: trigger
            id: anchor_end_evening
          - condition: template
            value_template: "{{ not evening_peak_critical }}"
        sequence: !input regular_anchor_end_evening_action
      
      # ============================================
      # EVENING PREHEAT (calendar trigger with offset, critical only)
      # ============================================
      - conditions:
          - condition: trigger
            id: preheat_evening
        sequence: !input critical_preheat_evening_action
      
      # ============================================
      # EVENING PEAK START (16:00)
      # ============================================
      - conditions:
          - condition: trigger
            id: peak_start_evening
          - condition: template
            value_template: "{{ evening_peak_critical }}"
        sequence: !input critical_peak_start_action
      - conditions:
          - condition: trigger
            id: peak_start_evening
          - condition: template
            value_template: "{{ not evening_peak_critical }}"
        sequence: !input regular_peak_start_action
      
      # ============================================
      # EVENING PEAK END (20:00)
      # ============================================
      - conditions:
          - condition: trigger
            id: peak_end_evening
          - condition: template
            value_template: "{{ evening_peak_critical }}"
        sequence: !input critical_peak_end_action
      - conditions:
          - condition: trigger
            id: peak_end_evening
          - condition: template
            value_template: "{{ not evening_peak_critical }}"
        sequence: !input regular_peak_end_action

