blueprint:
  name: Hydro-Qu√©bec Flex D (√âv√©nements de calendrier)
  description: '# Gestion des √©v√©nements de pointe critique "Flex D" via calendrier.


    Ce blueprint utilise les √©v√©nements de calendrier cr√©√©s automatiquement par l''int√©gration
    Hydro-Qu√©bec pour d√©clencher vos automatisations lors des p√©riodes de pointe critique.


    **Pr√©requis** : Vous devez avoir configur√© un calendrier dans les options de
    votre int√©gration Hydro-Qu√©bec Flex-D (DPC).


    ## Configuration


    ### S√©lection du calendrier

    S√©lectionnez le calendrier que vous avez configur√© dans l''int√©gration Hydro-Qu√©bec
    pour recevoir les √©v√©nements de pointe critique.


    ### P√©riode de pr√©-chauffage

    D√©finissez combien de temps avant le d√©but de l''√©v√©nement vous souhaitez commencer
    le pr√©-chauffage de votre r√©sidence (en minutes).


    ### Actions


    D√©finition des actions √† effectuer dans Home-Assistant lors de chaque d√©but et
    fin de p√©riodes.


    ### M√©tadonn√©es disponibles


    Les √©v√©nements de calendrier incluent des m√©tadonn√©es accessibles dans vos actions :

    - trigger.calendar_event.summary : Titre (üî¥ Pointe critique / ‚ö™ Pointe r√©guli√®re)

    - trigger.calendar_event.location : Tarif (Hydro-Qu√©bec DPC)

    - trigger.calendar_event.description : Contient Critique: Oui/Non, Tarif: DPC, etc.


    **Exemple de condition** pour filtrer uniquement les pointes critiques :

    condition: template / value_template: "{{ ''Critique: Oui'' in trigger.calendar_event.description }}"


    Vous trouverez plus de d√©tails sur les logiques applicables pour Flex-D

    dans la [documentation Hydro-Qu√©bec](https://www.hydroquebec.com/residentiel/espace-clients/tarifs/tarif-flex-d.html).

    '
  domain: automation
  input:
    hydroqc_calendar:
      name: Calendrier Hydro-Qu√©bec
      description: S√©lectionnez le calendrier configur√© dans l'int√©gration Hydro-Qu√©bec pour les √©v√©nements de pointe critique
      selector:
        entity:
          domain: calendar
          multiple: false
    preheat_minutes:
      name: Minutes de pr√©-chauffage avant l'√©v√©nement
      description: Nombre de minutes avant le d√©but de l'√©v√©nement pour commencer le pr√©-chauffage (par exemple -120 = 2 heures avant)
      default: -120
      selector:
        number:
          min: -360
          max: 0
          step: 15
          unit_of_measurement: minutes
          mode: slider
    pre_heat_start_action:
      name: Action de pr√©-chauffage
      description: Actions √† effectuer avant la p√©riode de pointe critique pour
        pr√©-chauffer votre r√©sidence.
      default: []
      selector:
        action: {}
    critical_peak_start_action:
      name: Action d√©but pointe critique
      description: Actions √† effectuer au d√©but de la p√©riode de pointe critique pour
        r√©duire votre consommation √©lectrique.
      default: []
      selector:
        action: {}
    critical_peak_end_action:
      name: Action fin pointe critique
      description: Actions √† effectuer √† la fin de la p√©riode de pointe critique pour
        r√©tablir votre consommation normale.
      default: []
      selector:
        action: {}
  source_url: https://github.com/hydroqc/hydroqc-ha/blob/main/blueprints/flex-d-calendar.yaml
mode: parallel
trigger:
  - platform: calendar
    entity_id: !input hydroqc_calendar
    event: start
    offset: !input preheat_minutes
    id: pre_heat_trigger
  - platform: calendar
    entity_id: !input hydroqc_calendar
    event: start
    id: peak_start_trigger
  - platform: calendar
    entity_id: !input hydroqc_calendar
    event: end
    id: peak_end_trigger
# Add condition to filter only peak events (title contains "pointe")
condition:
  - condition: template
    value_template: "{{ 'pointe' in trigger.calendar_event.summary | lower }}"
action:
  - choose:
      - conditions:
          - condition: trigger
            id: pre_heat_trigger
          # Optional: Add rate filter (trigger.calendar_event.location contains 'DPC')
          # Optional: Check if critical (trigger.calendar_event.description contains 'Critique: Oui')
        sequence: !input pre_heat_start_action
      - conditions:
          - condition: trigger
            id: peak_start_trigger
        sequence: !input critical_peak_start_action
      - conditions:
          - condition: trigger
            id: peak_end_trigger
        sequence: !input critical_peak_end_action
