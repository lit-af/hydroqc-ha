blueprint:
  name: Hydro-Qu√©bec Flex D (√âv√©nements de calendrier)
  description: |
    # Gestion des √©v√©nements de pointe critique "Flex D" via calendrier.

    Ce blueprint utilise les √©v√©nements de calendrier cr√©√©s automatiquement par l'int√©gration Hydro-Qu√©bec pour d√©clencher vos automatisations lors des p√©riodes de pointe critique.

    **Pr√©requis** : Vous devez avoir configur√© un calendrier dans les options de votre int√©gration Hydro-Qu√©bec Flex-D (DPC).

    ## Configuration

    ### S√©lection du calendrier

    S√©lectionnez le calendrier que vous avez configur√© dans l'int√©gration Hydro-Qu√©bec pour recevoir les √©v√©nements de pointe critique.

    ### P√©riode de pr√©-chauffage

    D√©finissez combien de temps avant le d√©but de chaque pointe (matin et soir) vous souhaitez commencer le pr√©-chauffage de votre r√©sidence. Vous pouvez configurer des d√©lais diff√©rents pour le matin et le soir selon vos besoins de chauffage.

    ### Actions

    D√©finition des actions √† effectuer dans Home-Assistant lors de chaque d√©but et fin de p√©riodes.

    **Important** : Pour √©viter qu'une erreur dans une action emp√™che l'ex√©cution des actions suivantes, il est recommand√© d'utiliser des appels d'actions en parall√®le. Exemple : au lieu d'une s√©quence simple, utilisez `parallel:` pour grouper vos actions.

    **Workflows complexes** : Si vous avez besoin de logiques conditionnelles complexes ou de nombreuses √©tapes, il est recommand√© d'utiliser ce blueprint pour d√©clencher des automatisations s√©par√©es plut√¥t que d'inclure toute la logique ici. Cela facilite la maintenance et le d√©bogage.


    ### M√©tadonn√©es disponibles


    Les √©v√©nements de calendrier incluent des m√©tadonn√©es accessibles dans vos actions :

    - trigger.calendar_event.summary : Titre (üî¥ Pointe critique)

    - trigger.calendar_event.description : Contient Critique: Oui, Tarif: DPC, etc.


    ### Cr√©ation manuelle d'√©v√©nements

    Si l'int√©gration ne cr√©e pas automatiquement les √©v√©nements (API indisponible, probl√®me de configuration), vous pouvez les cr√©er en utilisant le service `hydroqc.create_peak_event` avec la date et le cr√©neau (AM ou PM).


    Vous trouverez plus de d√©tails sur les logiques applicables pour Flex-D dans la [documentation Hydroqc](https://hydroqc.ca/fr/docs/tarification-dynamique/).

  domain: automation
  input:
    hydroqc_calendar:
      name: Calendrier Hydro-Qu√©bec
      description: S√©lectionnez le calendrier configur√© dans l'int√©gration Hydro-Qu√©bec pour les √©v√©nements de pointe critique
      selector:
        entity:
          domain: calendar
          multiple: false
    preheat_offset_morning:
      name: D√©lai de pr√©-chauffage (matin)
      description: "Temps avant le d√©but de la pointe du matin pour commencer le pr√©-chauffage (format -HH:MM:SS, ex: -02:00:00 pour 2 heures avant, -01:30:00 pour 1h30 avant)"
      default: "-02:00:00"
      selector:
        text:
          type: text
    preheat_offset_evening:
      name: D√©lai de pr√©-chauffage (soir)
      description: "Temps avant le d√©but de la pointe du soir pour commencer le pr√©-chauffage (format -HH:MM:SS, ex: -02:00:00 pour 2 heures avant, -01:30:00 pour 1h30 avant)"
      default: "-02:00:00"
      selector:
        text:
          type: text
    critical_peak_offset:
      name: D√©lai avant d√©but pointe critique
      description: "Temps avant le d√©but officiel de la pointe pour d√©clencher les actions (permet aux appareils de se stabiliser avant la pointe). Format -HH:MM:SS, ex: -00:01:00 pour 1 minute avant"
      default: "-00:01:00"
      selector:
        text:
          type: text
    
    # ===== ACTIONS =====
    pre_heat_start_morning_action:
      name: Action de pr√©-chauffage (matin)
      description: Actions √† effectuer avant la p√©riode de pointe critique du matin pour
        pr√©-chauffer votre r√©sidence.
      default:
        - parallel:
            - action: persistent_notification.create
              data:
                title: "üî• Pr√©-chauffage Flex-D (matin)"
                message: "D√©but du pr√©-chauffage avant pointe critique du matin. Augmentez le chauffage maintenant."
      selector:
        action: {}
    pre_heat_start_evening_action:
      name: Action de pr√©-chauffage (soir)
      description: Actions √† effectuer avant la p√©riode de pointe critique du soir pour
        pr√©-chauffer votre r√©sidence.
      default:
        - parallel:
            - action: persistent_notification.create
              data:
                title: "üî• Pr√©-chauffage Flex-D (soir)"
                message: "D√©but du pr√©-chauffage avant pointe critique du soir. Augmentez le chauffage maintenant."
      selector:
        action: {}
    critical_peak_start_action:
      name: Action d√©but pointe critique
      description: Actions √† effectuer au d√©but de la p√©riode de pointe critique pour
        r√©duire votre consommation √©lectrique.
      default:
        - parallel:
            - action: persistent_notification.create
              data:
                title: "üî¥ Pointe critique Flex-D"
                message: "D√©but de la pointe critique. R√©duisez votre consommation maintenant."
      selector:
        action: {}
    critical_peak_end_action:
      name: Action fin pointe critique
      description: |
        Actions √† effectuer √† la fin de la p√©riode de pointe critique pour
        r√©tablir votre consommation normale.
        
        **D√©lai al√©atoire par d√©faut (30 sec - 5 min)** : √âvite une surcharge du r√©seau √©lectrique caus√©e par le red√©marrage simultan√© de milliers d'appareils √† la fin de la pointe. Si vous avez plusieurs actions de reprise, ajoutez un d√©lai al√©atoire similaire entre chacune pour √©taler la consommation.
      default:
        - delay:
            seconds: "{{ range(30, 300)|random|int }}"
          alias: D√©lai al√©atoire 30 sec - 5 minutes
        - parallel:
            - action: persistent_notification.create
              data:
                title: "‚úÖ Fin pointe critique Flex-D"
                message: "Fin de la pointe critique. Vous pouvez r√©tablir votre consommation normale."
      selector:
        action: {}
  source_url: https://github.com/hydroqc/hydroqc-ha/blob/main/blueprints/flex-d-calendar.yaml
mode: parallel
trigger:
  # Pre-heat start morning: configurable offset before morning peak
  - platform: calendar
    entity_id: !input hydroqc_calendar
    event: start
    offset: !input preheat_offset_morning
    id: pre_heat_morning_trigger
  # Pre-heat start evening: configurable offset before evening peak
  - platform: calendar
    entity_id: !input hydroqc_calendar
    event: start
    offset: !input preheat_offset_evening
    id: pre_heat_evening_trigger
  # Critical peak start: configurable offset before official peak start (default 1min before)
  - platform: calendar
    entity_id: !input hydroqc_calendar
    event: start
    offset: !input critical_peak_offset
    id: peak_start_trigger
  - platform: calendar
    entity_id: !input hydroqc_calendar
    event: end
    id: peak_end_trigger
# Add condition to filter only peak events (title contains "pointe") and DPC rate
condition:
  - condition: template
    value_template: "{{ 'pointe' in trigger.calendar_event.summary | lower }}"
  - condition: template
    value_template: "{{ 'Tarif: DPC' in trigger.calendar_event.description }}"
action:
  - choose:
      # Pre-heat morning - CRITICAL ONLY
      - conditions:
          - condition: trigger
            id: pre_heat_morning_trigger
          - condition: template
            value_template: "{{ as_timestamp(trigger.calendar_event.start) | timestamp_custom('%H') | int < 12 }}"
          - condition: template
            value_template: "{{ 'Critique: Oui' in trigger.calendar_event.description }}"
        sequence: !input pre_heat_start_morning_action
      # Pre-heat evening - CRITICAL ONLY
      - conditions:
          - condition: trigger
            id: pre_heat_evening_trigger
          - condition: template
            value_template: "{{ as_timestamp(trigger.calendar_event.start) | timestamp_custom('%H') | int >= 12 }}"
          - condition: template
            value_template: "{{ 'Critique: Oui' in trigger.calendar_event.description }}"
        sequence: !input pre_heat_start_evening_action
      - conditions:
          - condition: trigger
            id: peak_start_trigger
          - condition: template
            value_template: "{{ 'Critique: Oui' in trigger.calendar_event.description }}"
        sequence: !input critical_peak_start_action
      - conditions:
          - condition: trigger
            id: peak_end_trigger
          - condition: template
            value_template: "{{ 'Critique: Oui' in trigger.calendar_event.description }}"
        sequence: !input critical_peak_end_action
    default:
      
